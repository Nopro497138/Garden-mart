<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Garden Mart</title>
  <link rel="icon" type="image/png" href="images/favicon.png" />
  <style>
    /* Reset */
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color:#fff;
      background:#021004;
      overflow-x:hidden;
    }

    /* ===== Star Canvas + Green Nebula ===== */
    #star-canvas{position:fixed;inset:0;z-index:0}
    .nebula{
      position:fixed;inset:0;z-index:0;pointer-events:none;
      background:
        radial-gradient(800px 500px at 10% 20%, rgba(0,255,120,0.14), transparent 10%),
        radial-gradient(900px 500px at 80% 70%, rgba(0,180,100,0.08), transparent 8%),
        radial-gradient(600px 350px at 50% 40%, rgba(80,255,180,0.06), transparent 6%);
      filter: blur(40px) saturate(1.05);
      opacity:0.95; mix-blend-mode: screen;
      animation: nebMove 26s linear infinite, nebRotate 60s linear infinite;
    }
    @keyframes nebMove { 0%{transform:translateY(0)}50%{transform:translateY(-40px)}100%{transform:translateY(0)} }
    @keyframes nebRotate { 0%{transform:rotate(0deg)}100%{transform:rotate(360deg)} }

    .gloss { position:fixed;inset:0;z-index:0;pointer-events:none; background:
      linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0));
      mix-blend-mode: overlay; opacity:0.6;
    }

    /* ===== Header ===== */
    header{
      position:relative;z-index:3;display:flex;justify-content:space-between;align-items:center;
      padding:20px 36px;
      background:linear-gradient(90deg, rgba(0,255,120,0.08), rgba(0,180,80,0.04));
      backdrop-filter: blur(6px);
      border-bottom:1px solid rgba(255,255,255,0.05);
    }
    header h1{
      font-size:32px;letter-spacing:1px;color:#caffdd;
      text-shadow:0 0 18px rgba(100,255,160,0.12)
    }
    .cart-button{
      background:linear-gradient(90deg,#fff,#f4fff6);
      color:#007a4d;
      border:none; padding:10px 20px; border-radius:14px;
      font-weight:900; cursor:pointer; font-size:18px;
      box-shadow:0 12px 36px rgba(0,150,80,0.08);
      transition: transform .18s ease, box-shadow .18s ease;
    }
    .cart-button:hover{ transform:translateY(-4px); box-shadow:0 22px 48px rgba(0,150,80,0.12) }

    /* ===== Layout ===== */
    .container{position:relative;z-index:2;display:flex;gap:28px;max-width:1400px;margin:20px auto;padding:0 28px 100px}
    .sidebar{
      width:240px;
      background:linear-gradient(180deg, rgba(0,40,20,0.7), rgba(0,20,10,0.65));
      padding:20px;border-radius:16px;
      border:1px solid rgba(0,255,150,0.12);
      box-shadow:0 28px 80px rgba(0,40,20,0.6);
      backdrop-filter: blur(6px);
    }
    .sidebar button{
      display:block;width:100%;margin-bottom:14px;padding:14px;border-radius:14px;border:none;
      background:linear-gradient(90deg,#00ff88,#00b46d);
      color:#012b16;font-weight:900;font-size:16px;cursor:pointer;
      box-shadow:0 12px 36px rgba(0,150,80,0.12);
      transition: transform .14s, box-shadow .14s;
    }
    .sidebar button:hover{ transform:translateY(-6px); box-shadow:0 18px 46px rgba(0,150,80,0.16) }

    /* ===== Products Grid ===== */
    .products{flex:1;display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:28px;align-content:start}
    .product{
      background:linear-gradient(180deg, rgba(4,40,20,0.9), rgba(2,20,10,0.88));
      border-radius:18px;padding:20px;
      border:1px solid rgba(0,255,150,0.10);
      box-shadow:0 28px 90px rgba(0,0,0,0.75);
      transition: transform .18s ease, box-shadow .18s ease, filter .18s;
      cursor: pointer;
    }
    .product:hover{ transform:translateY(-10px) scale(1.02); box-shadow:0 40px 120px rgba(0,255,160,0.18); filter:brightness(1.02) }
    .product img{width:100%;height:240px;object-fit:cover;border-radius:14px;margin-bottom:14px;background:linear-gradient(180deg,#222,#111)}
    .product h3{font-size:22px;margin-bottom:8px}
    .product p{font-size:18px;color:#d6ffec;margin-bottom:12px;font-weight:800}
    .product button{
      width:100%;padding:14px;border-radius:14px;border:none;
      background:linear-gradient(90deg,#00ff88,#00b46d);
      color:#012b16;font-weight:900;font-size:18px;cursor:pointer;
      transition:transform .12s;
    }
    .product button:hover{transform:translateY(-5px)}

    /* ===== Modal ===== */
    .modal{position:fixed;inset:0;z-index:12;display:none;align-items:center;justify-content:center;
      background:linear-gradient(180deg, rgba(0,0,0,0.6), rgba(0,0,0,0.9));padding:26px}
    .modal-content{
      width:400px;background:linear-gradient(180deg, rgba(0,40,20,0.96), rgba(0,20,10,0.98));
      border-radius:16px;padding:20px;
      border:1px solid rgba(0,255,150,0.12);
      box-shadow:0 36px 120px rgba(0,0,0,0.9);
    }
    .modal h2{color:#d6ffe7;margin-bottom:10px;text-align:center}
    .checkout-item{
      display:flex;justify-content:space-between;align-items:center;
      padding:12px;border-radius:12px;background:rgba(255,255,255,0.02);margin-bottom:10px
    }
    .remove-btn{background:none;color:#ff7d7d;border:none;font-size:18px;cursor:pointer}
    .checkout-footer{display:flex;justify-content:center;gap:12px;margin-top:18px}
    .buy-btn{
      padding:10px 20px;background:linear-gradient(90deg,#00ff88,#00b46d);
      color:#012b16;font-weight:900;border:none;border-radius:8px;cursor:pointer;
    }
    .buy-btn:hover{background:linear-gradient(90deg,#00e67a,#009f5f)}
    .cancel-btn{
      padding:10px 20px;background:#444;color:white;border:none;border-radius:8px;cursor:pointer;
    }
    .cancel-btn:hover{background:#666}

    /* Mutation modal specific - REPLACED with modern flowing layout + animations */
    /* --- Mutations list: modern horizontal multi-column layout + animations --- */
    .mutations-list{
      /* lay out items vertically into columns that flow horizontally */
      display: grid;
      grid-auto-flow: column;
      grid-auto-rows: min-content;
      gap: 10px 16px;
      align-items: start;
      max-width: 100%;
      overflow-x: auto;              /* allow the extra columns to exist to the right */
      padding: 8px 6px;
      scroll-behavior: smooth;       /* smooth animated scroll for arrows */
      -webkit-overflow-scrolling: touch;
      /* subtle mask so items fade towards edges */
      mask-image: linear-gradient(90deg, transparent 0%, black 8%, black 92%, transparent 100%);
    }

    /* each option is sized to form a column; it will stack vertically within the column */
    .mutation-option{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:12px 14px;
      border-radius:12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.018), rgba(0,0,0,0.02));
      cursor:pointer;
      min-width: 260px;              /* controls column width; adjust to taste */
      max-width: 320px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.45);
      transition: transform .22s cubic-bezier(.2,.9,.2,1), box-shadow .22s, background .22s;
    }

    /* hover lift */
    .mutation-option:hover{
      transform: translateY(-6px);
      box-shadow: 0 18px 56px rgba(0,255,160,0.08);
      background: linear-gradient(180deg, rgba(0,255,140,0.02), rgba(0,100,60,0.02));
    }

    /* visually hide native radio but keep accessible */
    .mutation-option input[type="radio"]{
      position: absolute;
      opacity: 0;
      pointer-events: none;
      width: 0; height: 0;
    }

    /* label text block (we rely on `input + span`) */
    .mutation-option > div { display:flex; align-items:center; gap:12px; }
    /* the visible name */
    .mutation-option span {
      position: relative;
      padding-left: 36px;
      font-size: 18px;
      color: #e8fff2;
    }

    /* custom radio circle shown via span::before */
    .mutation-option span::before{
      content: '';
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%) scale(1);
      width: 22px; height: 22px;
      border-radius: 999px;
      border: 2px solid rgba(255,255,255,0.06);
      background: linear-gradient(180deg, rgba(0,255,160,0.06), rgba(0,120,60,0.02));
      box-shadow: 0 4px 14px rgba(0,120,60,0.06), inset 0 1px 0 rgba(255,255,255,0.02);
      transition: transform .22s cubic-bezier(.2,.9,.2,1), box-shadow .22s, background .22s;
    }

    /* inner fill shown when checked */
    .mutation-option input[type="radio"]:checked + span::after{
      content: '';
      position: absolute;
      left: 6px;
      top: 50%;
      transform: translateY(-50%) scale(1);
      width: 10px; height: 10px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, #ffffff, rgba(255,255,255,0.85) 10%, rgba(0,140,80,1) 60%);
      box-shadow: 0 6px 18px rgba(0,200,120,0.18);
      transition: transform .18s cubic-bezier(.2,.9,.2,1), box-shadow .18s;
      animation: radioPulse .42s ease;
    }

    /* subtle anim on check */
    @keyframes radioPulse {
      0% { transform: translateY(-50%) scale(0.6); opacity: 0; }
      60% { transform: translateY(-50%) scale(1.15); opacity: 1; }
      100% { transform: translateY(-50%) scale(1); opacity: 1; }
    }

    /* amount text on right */
    .mutation-option > div + div {
      min-width: 72px;
      text-align: right;
      color: #dfffe8;
      font-weight: 700;
      font-size: 16px;
    }

    /* nav arrow buttons that show when list overflows */
    .mutations-nav{
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      z-index: 20;
      width: 38px;
      height: 38px;
      border-radius: 999px;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(0,0,0,0.06));
      box-shadow: 0 8px 28px rgba(0,20,10,0.6);
      cursor: pointer;
      opacity: 0;
      pointer-events: none;
      transition: opacity .22s, transform .22s;
    }

    /* show them when parent gets `.has-navs` (added in JS) */
    .modal-content.has-navs .mutations-nav{ opacity: 1; pointer-events: auto; }

    .mutations-nav.left{ left: 8px; transform: translateY(-50%) translateX(-6px); }
    .mutations-nav.right{ right: 8px; transform: translateY(-50%) translateX(6px); }

    .mutations-nav:hover{ transform: translateY(-50%) scale(1.06); box-shadow: 0 14px 40px rgba(0,200,120,0.12); }

    /* arrow glyph */
    .mutations-nav svg{ width:18px; height:18px; fill: #eafff0; opacity: 0.96; }

    /* modal pop animation (applies to modal-content) */
    .modal-content{
      animation: modalPop .28s cubic-bezier(.2,.9,.2,1);
      will-change: transform, opacity;
    }
    @keyframes modalPop {
      0% { transform: translateY(12px) scale(.98); opacity: 0; }
      60% { transform: translateY(-6px) scale(1.01); opacity: 1; }
      100% { transform: translateY(0) scale(1); opacity: 1; }
    }

    /* small-screen adjustment: allow modal-content to be a bit wider when mutations overflow */
    @media (max-width: 480px) {
      .modal-content { width: 94%; padding: 14px; }
      .mutation-option { min-width: 220px; }
    }
    @media (min-width: 481px) {
      /* allow the mutation modal to expand more when needed */
      #mutation-modal .modal-content { max-width: 820px; width: min(92%, 820px); }
    }

    /* Cart badge */
    #cart-count{display:inline-block;padding:2px 8px;border-radius:999px;background:linear-gradient(90deg,#d6ffeb,#9effce);color:#01301c;font-weight:900;margin-left:6px}

    /* === Responsive Scaling (nur hinzugefügt) === */
    @media (max-width: 1200px) {
      .container { padding: 0 20px 80px; gap: 22px; }
      .products { grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 22px; }
    }
    @media (max-width: 1024px) {
      .container { flex-direction: column; }
      .sidebar { width: 100%; display: flex; gap: 10px; flex-wrap: wrap; }
      .sidebar button { flex: 1 1 calc(50% - 10px); }
    }
    @media (max-width: 768px) {
      header h1 { font-size: 24px; }
      .cart-button { font-size: 16px; padding: 8px 14px; }
      .container { padding: 0 16px 70px; gap: 18px; }
      .products { grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 18px; }
      .product img { height: 200px; }
    }
    @media (max-width: 480px) {
      header { flex-direction: column; gap: 10px; padding: 14px 16px; }
      .sidebar { gap: 8px; }
      .sidebar button { flex: 1 1 100%; font-size: 14px; padding: 10px; }
      .products { grid-template-columns: 1fr; gap: 14px; }
      .product { padding: 16px; }
      .product img { height: 180px; }
      .modal-content { width: 92%; padding: 16px; }
    }
  </style>
</head>
<body>
  <!-- Canvas & Nebula -->
  <canvas id="star-canvas"></canvas>
  <div class="nebula" aria-hidden="true"></div>
  <div class="gloss" aria-hidden="true"></div>

  <header>
    <h1>Garden Mart</h1>
    <button class="cart-button" onclick="openCart()">🛒 Cart (<span id="cart-count">0</span>)</button>
  </header>

  <div class="container">
    <div class="sidebar">
      <button onclick="showCategory('all')">All Products</button>
      <button onclick="showCategory('pets')">Pets</button>
      <button onclick="showCategory('sheckles')">Sheckles</button>
      <button onclick="showCategory('bundles')">Bundles</button>
    </div>

    <div class="products" id="products"></div>
  </div>

  <!-- Checkout Modal -->
  <div id="cart-modal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <h2>Checkout</h2>
      <div id="cart-items"></div>
      <p style="text-align:center;color:#ccc;">Payment Method: PayPal</p>
      <div class="checkout-footer">
        <button class="buy-btn" onclick="buyItems()">Buy</button>
        <button class="cancel-btn" onclick="closeCart()">Close</button>
      </div>
    </div>
  </div>

  <!-- Mutation Modal (for pets) -->
  <div id="mutation-modal" class="modal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="mutation-title">
      <h2 id="mutation-title">Choose a mutation</h2>
      <p id="mutation-product-name" style="text-align:center;color:#cfefe0;margin-bottom:8px;"></p>
      <div class="mutations-list" id="mutations-list">
        <!-- options injected here -->
      </div>
      <div class="checkout-footer" style="margin-top:14px">
        <button class="buy-btn" id="mutation-confirm">Add to Cart</button>
        <button class="cancel-btn" onclick="closeMutationModal()">Cancel</button>
      </div>
    </div>
  </div>

  <audio id="click-sound" src="click.mp3" preload="auto"></audio>

  <script>
    /* === Star background animation === */
    const canvas = document.getElementById('star-canvas');
    const ctx = canvas.getContext('2d');
    let W = canvas.width = innerWidth, H = canvas.height = innerHeight;
    window.addEventListener('resize', ()=>{ W = canvas.width = innerWidth; H = canvas.height = innerHeight; initStars(); });
    function rand(a,b){ return Math.random()*(b-a)+a; }
    let stars = [];
    const STAR_COUNT = Math.floor((window.innerWidth*window.innerHeight)/28000) + 90;
    function initStars(){
      stars = [];
      for(let i=0;i<STAR_COUNT;i++){
        stars.push({
          x: Math.random()*W,
          y: Math.random()*H,
          z: rand(0.2,1.2),
          r: rand(0.3,1.9),
          dx: rand(-0.04,0.04),
          dy: rand(-0.03,0.03),
          tw: Math.random()*1.8
        });
      }
    }
    initStars();
    let t=0;
    function drawStars(){
      ctx.clearRect(0,0,W,H);
      const g = ctx.createLinearGradient(0,0,W,H);
      g.addColorStop(0,'rgba(120,255,200,0.01)');
      g.addColorStop(1,'rgba(0,200,120,0.01)');
      ctx.fillStyle = g; ctx.fillRect(0,0,W,H);
      for(const s of stars){
        const tw = Math.sin(t*0.02*s.tw)*0.7 + 0.8;
        const size = s.r * tw * s.z;
        ctx.beginPath();
        ctx.fillStyle = `rgba(255,255,255,${0.55 * s.z * tw})`;
        ctx.arc(s.x,s.y,Math.max(0.2,size),0,Math.PI*2); ctx.fill();
        s.x += s.dx*(1+0.6*s.z);
        s.y += s.dy*(1+0.6*s.z);
        if(s.x < -10) s.x = W+10; if(s.x > W+10) s.x = -10;
        if(s.y < -10) s.y = H+10; if(s.y > H+10) s.y = -10;
      }
      t++; requestAnimationFrame(drawStars);
    }
    drawStars();

    /* === Script: load mutations from products.json when available === */
    let productsData = [];
    let cart = [];

    // default mutations used if product doesn't have its own "mutations" field
    const DEFAULT_MUTATIONS = [
      { "id": "none", "name": "None", "delta": 0 },
      { "id": "shiny", "name": "Shiny mutation", "delta": 0.50 },
      { "id": "inverted", "name": "Inverted mutation", "delta": 1.00 },
      { "id": "frozen", "name": "Frozen mutation", "delta": 1.50 },
      { "id": "windy", "name": "Windy mutation", "delta": 2.00 },
      { "id": "golden", "name": "Golden mutation", "delta": 2.50 },
      { "id": "mega", "name": "Mega mutation", "delta": 3.00 },
      { "id": "tiny", "name": "Tiny mutation", "delta": 3.50 },
      { "id": "ironskin", "name": "Ironskin", "delta": 4.00 },
      { "id": "radiant", "name": "Radiant mutation", "delta": 4.50 },
      { "id": "schocked", "name": "Schocked mutation", "delta": 5.00 },
      { "id": "tranquil", "name": "Tranquil mutation", "delta": 5.50 },
      { "id": "corrupted", "name": "Corrupted mutation", "delta": 6.00 },
      { "id": "rainbow", "name": "Rainbow mutation", "delta": 6.50 },
      { "id": "ascended", "name": "Ascended mutation", "delta": 8.00 }
    ];

    function playClick() {
      const audio = document.getElementById("click-sound");
      if (audio && audio.play) {
        audio.currentTime = 0;
        audio.play().catch(() => {});
      }
    }

    function fmtPrice(v) {
      const n = (typeof v === 'number') ? v : parseFloat(v);
      if (isNaN(n)) return v;
      return n.toFixed(2);
    }

    function normalizeMutations(arr) {
      // Accept several shapes:
      // { id, name, delta } OR { name, price } OR { name, delta }
      const out = Array.isArray(arr) ? arr.map((m, i) => {
        const name = m.name || m.label || ('Option ' + (i+1));
        const id = m.id || name.toString().toLowerCase().replace(/\s+/g,'-') || ('m' + i);
        let delta = 0;
        if (m.delta !== undefined) delta = parseFloat(m.delta);
        else if (m.price !== undefined) delta = parseFloat(m.price);
        else if (m.amount !== undefined) delta = parseFloat(m.amount);
        if (isNaN(delta)) delta = 0;
        return { id, name, delta };
      }) : [];
      // Ensure a 'none' option exists as first choice
      if (!out.find(x => x.id === 'none')) out.unshift({ id: 'none', name: 'None', delta: 0 });
      return out;
    }

    // Modified showProducts: uses handleAddClick and opens mutation modal on product click for pets.
    function showProducts(filter) {
      const container = document.getElementById("products");
      container.innerHTML = "";
      const filtered = (filter === "all" || !filter) ? productsData : productsData.filter(p => p.category === filter);
      filtered.forEach(product => {
        const el = document.createElement("div");
        el.classList.add("product");
        const price = fmtPrice(product.price);
        el.innerHTML = `
          <img src="${product.image}" alt="${product.name}">
          <h3>${product.name}</h3>
          <p>$${price}</p>
          <button onclick="handleAddClick(${product.id}); playClick(); event.stopPropagation()">Add to Cart</button>
        `;

        // clicking the product container (not the button) will also open mutation menu for pets or add directly for others
        el.addEventListener('click', (e) => {
          if (e.target.tagName.toLowerCase() === 'button') return; // already handled by button
          handleAddClick(product.id);
          playClick();
        });

        container.appendChild(el);
      });
    }

    // Main entry when user wants to add a product to cart
    function handleAddClick(id) {
      const product = productsData.find(p => p.id === id);
      if (!product) return;
      // Only show mutation modal for category 'pets'
      if (product.category && product.category.toString().toLowerCase() === 'pets') {
        openMutationModal(product);
      } else {
        // behave exactly as before: direct add (no mutation)
        addToCartSimple(product);
      }
    }

    function addToCartSimple(product) {
      // preserve old shape for non-mutated items
      cart.push({
        id: product.id,
        name: product.name,
        image: product.image,
        price: (typeof product.price === 'number') ? product.price : parseFloat(product.price)
      });
      document.getElementById("cart-count").textContent = cart.length;
    }

    function addToCartWithMutation(product, mutation) {
      const basePrice = (typeof product.price === 'number') ? product.price : parseFloat(product.price);
      const delta = mutation && typeof mutation.delta === 'number' ? mutation.delta : parseFloat(mutation.delta || 0);
      const finalPrice = (isNaN(basePrice) ? product.price : (basePrice + (isNaN(delta) ? 0 : delta)));

      const cartItem = {
        id: product.id,
        name: product.name,
        image: product.image,
        basePrice: isNaN(basePrice) ? 0 : basePrice,
        mutation: mutation ? { id: mutation.id, name: mutation.name, delta: mutation.delta } : { id: 'none', name: 'None', delta: 0 },
        price: finalPrice
      };

      cart.push(cartItem);
      document.getElementById("cart-count").textContent = cart.length;
    }

    // Cart modal / listing
    function openCart() {
      playClick();
      const cartItems = document.getElementById("cart-items");
      cartItems.innerHTML = "";
      if (cart.length === 0) {
        cartItems.innerHTML = '<p style="text-align:center;color:#ccc;">Your cart is empty.</p>';
      } else {
        cart.forEach((item, index) => {
          const div = document.createElement("div");
          div.classList.add("checkout-item");

          if (item.mutation) {
            div.innerHTML = `
              <div style="display:flex;flex-direction:column;gap:6px;">
                <strong>${item.name}</strong>
                <small style="color:#cfefe0">${item.mutation && item.mutation.name !== 'None' ? item.mutation.name : ''}</small>
              </div>
              <div style="text-align:right;">
                <div>$${fmtPrice(item.price)}</div>
                <button class="remove-btn" onclick="removeItem(${index})">❌</button>
              </div>
            `;
          } else {
            const price = (typeof item.price === "number") ? item.price.toFixed(2) : item.price;
            div.innerHTML = `
              <span>${item.name} - $${price}</span>
              <button class="remove-btn" onclick="removeItem(${index})">❌</button>
            `;
          }
          cartItems.appendChild(div);
        });
      }
      document.getElementById("cart-modal").style.display = "flex";
    }

    function closeCart() {
      playClick();
      document.getElementById("cart-modal").style.display = "none";
    }

    function removeItem(index) {
      playClick();
      cart.splice(index, 1);
      document.getElementById("cart-count").textContent = cart.length;
      openCart();
    }

    function buyItems() {
      playClick();
      if (cart.length > 0) {
        window.location.href = "https://paypal.me/Mananquil19";
      }
    }

    /* === Mutation modal logic (enhanced: horizontal multi-column overflow + nav buttons) === */
    let _mutationTargetProduct = null; // product being mutated
    let _mutationNavLeft = null;
    let _mutationNavRight = null;

    function openMutationModal(product) {
      _mutationTargetProduct = product;
      const modal = document.getElementById("mutation-modal");
      const modalContent = modal.querySelector('.modal-content');
      const nameEl = document.getElementById("mutation-product-name");
      nameEl.textContent = `${product.name} — $${fmtPrice(product.price)}`;

      // Determine mutation options (product.mutations if present else DEFAULT_MUTATIONS)
      const raw = Array.isArray(product.mutations) ? product.mutations : null;
      const options = raw ? normalizeMutations(raw) : normalizeMutations(DEFAULT_MUTATIONS);

      // render mutation options into the existing #mutations-list
      const list = document.getElementById("mutations-list");
      list.innerHTML = "";

      options.forEach((m, idx) => {
        const opt = document.createElement("label");
        opt.className = 'mutation-option';
        // we keep the inner structure similar to before so the CSS selectors work
        opt.innerHTML = `
          <div style="display:flex;align-items:center;">
            <input type="radio" name="mutation" value="${m.id}" id="mut-${m.id}" ${idx===0 ? 'checked' : ''}>
            <span>${m.name}</span>
          </div>
          <div style="min-width:70px;text-align:right;">${m.delta === 0 ? '' : ('+$' + fmtPrice(m.delta))}</div>
        `;
        // clicking the label toggles the radio (native behavior preserved)
        list.appendChild(opt);
      });

      // ensure previous navs are removed (safety)
      closeMutationNavs();

      // detect overflow / need for navs after a short tick (allow DOM to layout)
      setTimeout(() => {
        const needNavs = list.scrollWidth > list.clientWidth + 6 || options.length > 8;
        if (needNavs) {
          // add navigation arrows to modal-content and toggle class so css shows them
          modalContent.classList.add('has-navs');

          // left arrow
          _mutationNavLeft = document.createElement('button');
          _mutationNavLeft.className = 'mutations-nav left';
          _mutationNavLeft.setAttribute('aria-label','Scroll left');
          _mutationNavLeft.innerHTML = `<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M15.41 7.41 14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>`;
          _mutationNavLeft.onclick = () => {
            list.scrollBy({ left: -Math.round(list.clientWidth * 0.6), behavior: 'smooth' });
          };
          modalContent.appendChild(_mutationNavLeft);

          // right arrow
          _mutationNavRight = document.createElement('button');
          _mutationNavRight.className = 'mutations-nav right';
          _mutationNavRight.setAttribute('aria-label','Scroll right');
          _mutationNavRight.innerHTML = `<svg viewBox="0 0 24 24" aria-hidden="true"><path d="M8.59 16.59 13.17 12 8.59 7.41 10 6l6 6-6 6z"/></svg>`;
          _mutationNavRight.onclick = () => {
            list.scrollBy({ left: Math.round(list.clientWidth * 0.6), behavior: 'smooth' });
          };
          modalContent.appendChild(_mutationNavRight);

          // small observer to toggle arrow visibility depending on scroll pos
          const toggleArrows = () => {
            if (!list) return;
            const atStart = list.scrollLeft <= 8;
            const atEnd = list.scrollLeft + list.clientWidth >= list.scrollWidth - 8;
            _mutationNavLeft.style.opacity = atStart ? '0.14' : '1';
            _mutationNavRight.style.opacity = atEnd ? '0.14' : '1';
          };
          list.addEventListener('scroll', toggleArrows);
          window.addEventListener('resize', toggleArrows);
          // initial call
          toggleArrows();
        } else {
          modalContent.classList.remove('has-navs');
        }
      }, 40);

      // attach confirm handler (overwrites previous)
      const confirmBtn = document.getElementById("mutation-confirm");
      confirmBtn.onclick = () => {
        const selectedId = (document.querySelector('input[name="mutation"]:checked') || {}).value || 'none';
        const selected = options.find(x => x.id === selectedId) || options[0];
        addToCartWithMutation(product, selected);
        closeMutationModal();
        playClick();
      };

      modal.style.display = 'flex';
      // put focus for accessibility
      setTimeout(() => {
        const firstInput = modal.querySelector('input[name="mutation"]');
        if (firstInput) firstInput.focus();
      }, 120);
    }

    function closeMutationNavs() {
      // remove any nav buttons that were created
      const existing = document.querySelectorAll('.mutations-nav');
      existing.forEach(n => n.remove());
      _mutationNavLeft = _mutationNavRight = null;
      // remove `.has-navs` flag
      const modalContent = document.querySelector('#mutation-modal .modal-content');
      if (modalContent) modalContent.classList.remove('has-navs');
    }

    function closeMutationModal() {
      const modal = document.getElementById("mutation-modal");
      modal.style.display = 'none';
      _mutationTargetProduct = null;
      // cleanup navs
      closeMutationNavs();
    }

    // close mutation modal by clicking outside content
    document.getElementById('mutation-modal').addEventListener('click', (e) => {
      if (e.target === document.getElementById('mutation-modal')) closeMutationModal();
    });

    // Also close cart modal by clicking outside
    document.getElementById('cart-modal').addEventListener('click', (e) => {
      if (e.target === document.getElementById('cart-modal')) closeCart();
    });

    /* === load products.json and keep product-specific mutations when present === */
    fetch('products.json')
      .then(response => {
        if (!response.ok) throw new Error('Could not load products.json');
        return response.json();
      })
      .then(data => {
        productsData = Array.isArray(data) ? data : (data.products || []);
        // ensure prices are numbers where possible
        productsData.forEach(p => {
          if (p.price !== undefined) {
            const n = parseFloat(p.price);
            if (!isNaN(n)) p.price = n;
          }
        });
        showProducts('all');
      })
      .catch(err => {
        console.error(err);
        const container = document.getElementById("products");
        container.innerHTML = '<p style="color:#f55; padding:30px;">Products could not be loaded. Check products.json.</p>';
      });
  </script>
</body>
</html>
